//à¹ƒà¸Šà¹‰à¸šà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡
/*async function fetchConfig() {
    const response = await fetch("http://localhost:3001/config"); 
    const config = await response.json();
    return config;
}*/

let config = null;  // âœ… à¸à¸³à¸«à¸™à¸”à¸•à¸±à¸§à¹à¸›à¸£ config à¹„à¸§à¹‰à¸—à¸µà¹ˆà¸”à¹‰à¸²à¸™à¸šà¸™à¸ªà¸¸à¸”

async function fetchConfig() {
    if (!config) {  // âœ… à¹‚à¸«à¸¥à¸”à¸„à¹ˆà¸²à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§
        try {
            const response = await fetch("/config");
            config = await response.json();
            console.log("âœ… Config Loaded:", config);
        } catch (error) {
            console.error("âŒ Failed to fetch config:", error);
            alert("âŒ Failed to load configuration. Please try again.");
            return null;  // âœ… à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ Error à¸–à¹‰à¸²à¹‚à¸«à¸¥à¸” config à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ
        }
    }
    return config;
}

// âœ… à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¹ƒà¸™ `loginWithGoogle()`
async function loginWithGoogle() {
    const config = await fetchConfig();  // âœ… à¹‚à¸«à¸¥à¸” config à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰

    if (!config || !config.clientId) {  // âœ… à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸„à¹ˆà¸²à¸¡à¸²à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
        console.error("âŒ Google Client ID is missing!");
        alert("âŒ Google Client ID not found. Please check the configuration.");
        return;
    }

    console.log("âœ… Google Client ID:", config.clientId);

    google.accounts.id.initialize({
        client_id: config.clientId,  // âœ… à¹ƒà¸Šà¹‰ clientId à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
        callback: async (response) => {
            if (!response.credential) {
                console.error("âŒ Google Login Failed: No credential received.");
                alert("âŒ Google Login Failed. Please check your Google account settings.");
                return;
            }

            console.log("âœ… Google Response:", response);

            const idToken = response.credential;  // âœ… à¹ƒà¸Šà¹‰ ID Token
            const serverResponse = await fetch(`${config.apiBaseUrl}/auth/google`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token: idToken })
            });

            const data = await serverResponse.json();
            console.log("ðŸ“¨ Server Response:", data);

            if (serverResponse.ok) {
                alert(`âœ… Login Success! \nName: ${data.name}\nEmail: ${data.email}`);
            } else {
                console.error("âŒ Server Error:", data);
                alert(`âŒ Login Failed: ${data.error}`);
            }
        },
        ux_mode: "redirect",  // âœ… à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ˆà¸²à¸ "popup" à¹€à¸›à¹‡à¸™ "redirect"
        //ux_mode: "popup",  // âœ… à¹ƒà¸Šà¹‰ popup à¹à¸—à¸™ FedCM
        //prompt: "consent",
        login_uri: `${config.apiBaseUrl}/auth/google/callback`,  // âœ… à¹ƒà¸Šà¹‰à¸„à¹ˆà¸² redirect URI à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
        itp_support: true,  // âœ… à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰ Intelligent Tracking Prevention (à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² Cookies à¸–à¸¹à¸à¸šà¸¥à¹‡à¸­à¸)
        use_fedcm_for_prompt: true  // âœ… à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ FedCM à¹€à¸žà¸·à¹ˆà¸­à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¹ƒà¸™à¸­à¸™à¸²à¸„à¸•
    });

    google.accounts.id.prompt((notification) => {
        console.log("ðŸ” Google Prompt Status:", notification);
    
        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
            console.error("âŒ Google Login Prompt was not displayed:", notification);
            //alert("âŒ Google Login was blocked. Try disabling pop-up blockers or using another browser.");

             // âœ… à¸šà¸±à¸‡à¸„à¸±à¸šà¹„à¸›à¸—à¸µà¹ˆà¸«à¸™à¹‰à¸² Google Login à¹€à¸•à¹‡à¸¡à¸£à¸¹à¸›à¹à¸šà¸š
            window.location.href = `https://accounts.google.com/o/oauth2/auth?client_id=${config.clientId}&redirect_uri=${config.apiBaseUrl}/auth/google/callback&response_type=code&scope=openid%20email%20profile`;

            console.log("ðŸ”— Redirecting to Google Login:", googleLoginUrl);
            window.location.href = googleLoginUrl;
        }
    }, { cancel_on_tap_out: false });

// ðŸ“Œ à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸­à¹ˆà¸²à¸™à¸„à¹ˆà¸²à¸ˆà¸²à¸ Query String à¹à¸¥à¸°à¹à¸ªà¸”à¸‡à¸œà¸¥à¸«à¸¥à¸±à¸‡ Redirect
window.onload = function () {
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get('success');
    const name = urlParams.get('name');
    const email = urlParams.get('email');

    if (success === 'true' && name && email) {
        alert(`âœ… Google Login Success!\nName: ${decodeURIComponent(name)}\nEmail: ${decodeURIComponent(email)}`);
    }
};
    
}

function loginWithMicrosoft() {
    window.location.href = "/auth/microsoft";
}

// Event Listeners
document.getElementById('language-switch').addEventListener('change', toggleLanguage);
document.getElementById('google-login').addEventListener('click', loginWithGoogle);
document.getElementById('microsoft-login').addEventListener('click', loginWithMicrosoft);

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ à¸²à¸©à¸²
function toggleLanguage() {
    const isThai = document.getElementById('language-switch').checked;

    // à¸­à¸‡à¸„à¹Œà¸›à¸£à¸°à¸à¸­à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    const elements = {
        mainTitle: document.getElementById('main-title'),
        subTitle: document.getElementById('sub-title'),
        message1: document.getElementById('message-1'),
        message2: document.getElementById('message-2'),
        loginTitle: document.getElementById('login-title'),
        googleLoginText: document.getElementById('google-login-text'),
        microsoftLoginText: document.getElementById('microsoft-login-text'),
        languageLabel: document.getElementById('language-label')
    };

    // à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹à¸¥à¸°à¸­à¸±à¸‡à¸à¸¤à¸©
    const textContent = {
        thai: {
            mainTitle: "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¸ªà¸¹à¹ˆ",
            subTitle: "à¸«à¸­à¸ªà¸¡à¸¸à¸”à¸¡à¸«à¸²à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µà¸žà¸£à¸°à¸ˆà¸­à¸¡à¹€à¸à¸¥à¹‰à¸²à¸˜à¸™à¸šà¸¸à¸£à¸µ",
            message1: "à¹ƒà¸™à¸«à¸™à¹‰à¸²à¸•à¹ˆà¸²à¸‡à¸™à¸µà¹‰à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸¢à¸·à¸¡à¸«à¸™à¸±à¸‡à¸ªà¸·à¸­à¸‚à¸­à¸‡à¸—à¹ˆà¸²à¸™",
            message2: "à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸œà¹ˆà¸²à¸™ Gmail à¹à¸¥à¸° Microsoft à¹„à¸”à¹‰à¹ƒà¸•à¹‰à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰",
            loginTitle: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
            googleLoginText: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸”à¹‰à¸§à¸¢ Google",
            microsoftLoginText: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸”à¹‰à¸§à¸¢ Microsoft",
            languageLabel: "à¸ à¸²à¸©à¸²à¹„à¸—à¸¢"
        },
        english: {
            mainTitle: "Welcome to",
            subTitle: "KMUTT Library",
            message1: "This window allows you to log in and check your book borrowing history.",
            message2: "You can log in via Gmail and Microsoft below.",
            loginTitle: "Login",
            googleLoginText: "Login with Google",
            microsoftLoginText: "Login with Microsoft",
            languageLabel: "English"
        }
    };

    const language = isThai ? "english" : "thai";
    elements.mainTitle.textContent = textContent[language].mainTitle;
    elements.subTitle.textContent = textContent[language].subTitle;
    elements.message1.textContent = textContent[language].message1;
    elements.message2.textContent = textContent[language].message2;
    elements.loginTitle.textContent = textContent[language].loginTitle;
    elements.googleLoginText.textContent = textContent[language].googleLoginText;
    elements.microsoftLoginText.textContent = textContent[language].microsoftLoginText;
    elements.languageLabel.textContent = textContent[language].languageLabel;
}

// à¹€à¸žà¸´à¹ˆà¸¡ Event Listener à¹€à¸¡à¸·à¹ˆà¸­à¸«à¸™à¹‰à¸²à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆ
document.addEventListener('DOMContentLoaded', () => {
    toggleLanguage();
    const languageSwitch = document.getElementById('language-switch');
    languageSwitch.addEventListener('change', toggleLanguage);
});
